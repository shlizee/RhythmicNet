This part of the code is copied from Magenta's codebase without any modification.